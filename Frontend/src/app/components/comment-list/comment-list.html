<div class="container mt-4">
    <button class="btn btn-success mb-3" (click)="toggleMainForm()">
        {{ showMainForm() ? 'Hide Comment Form' : 'Add Comment' }}
    </button>
    <app-comment-form *ngIf="showMainForm()"></app-comment-form>

    <div class="mt-3 mb-3 d-flex gap-2 align-items-center">
        <span>Sort by:</span>

        <button class="btn btn-sm btn-outline-primary"
                [class.active]="sortField === 'user'"
                (click)="changeSort('user')">
            User Name
            <span *ngIf="sortField === 'user'">({{ sortDirection }})</span>
        </button>

        <button class="btn btn-sm btn-outline-primary"
                [class.active]="sortField === 'email'"
                (click)="changeSort('email')">
            Email
            <span *ngIf="sortField === 'email'">({{ sortDirection }})</span>
        </button>

        <button class="btn btn-sm btn-outline-primary"
                [class.active]="sortField === 'date'"
                (click)="changeSort('date')">
            Date
            <span *ngIf="sortField === 'date'">({{ sortDirection }})</span>
        </button>
    </div>

    <!-- New comment notification -->
    <div *ngIf="newCommentReceived()" class="alert alert-info d-flex justify-content-between align-items-center">
        <div>New comment was added. <strong>Click to refresh</strong>.</div>
        <button class="btn btn-sm btn-outline-primary" (click)="reloadNow()">Refresh</button>
    </div>

    <h2>Comments</h2>

    <div *ngFor="let comment of comments" class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">{{ comment.userName }} ({{ comment.email }})</h5>
            <p class="card-text" [innerHTML]="comment.text" style="white-space: pre-wrap;"></p>
            <p class="card-subtitle mb-2 text-muted">{{ comment.createdAt | date: 'short' }}</p>

            <div *ngIf="comment.files && comment.files.length > 0" class="mt-2">
                <ng-container *ngFor="let file of comment.files">
                    <a *ngIf="file.contentType.startsWith('image/')"
                        [href]="'/api/files/' + file.id"
                        [attr.data-lightbox]="'comment-' + comment.id" [attr.data-title]="file.fileName"
                        style="margin-right: 8px;">
                        <img [src]="'/api/files/' + file.id" [alt]="file.fileName"
                            style="max-height: 100px;" />
                    </a>

                    <a *ngIf="file.contentType === 'text/plain'" href="javascript:void(0)"
                        (click)="onTextFileClick(file.id)" class="btn btn-sm btn-outline-secondary me-2">
                        {{ file.fileName }}
                    </a>
                </ng-container>
            </div>

            <div class="mt-3">
                <button class="btn btn-sm btn-outline-secondary me-2" (click)="toggleReplyForm(comment.id)">
                    {{ replyFormsVisible[comment.id] ? 'Cancel' : 'Reply' }}
                </button>

                <button *ngIf="comment.replyCount > 0" class="btn btn-sm btn-outline-primary"
                    (click)="toggleReplies(comment.id)">
                    {{ selectedCommentId === comment.id ? 'Hide Replies' : 'Show Replies (' + comment.replyCount + ')' }}
                </button>
            </div>

            <div *ngIf="replyFormsVisible[comment.id]" class="mt-3">
                <app-comment-form [parentCommentId]="comment.id"></app-comment-form>
            </div>

            <div *ngIf="selectedCommentId === comment.id" class="mt-3">
                <app-comment-replies [commentId]="comment.id"
                    (textFileRequested)="onTextFileClick($event)"></app-comment-replies>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between mt-4">
        <button class="btn btn-secondary d-flex align-items-center" (click)="prevPage()"
            [disabled]="currentPage === 1 || isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            ← Previous
        </button>
    
        <span>Page {{ currentPage }}</span>
    
        <button class="btn btn-secondary d-flex align-items-center" (click)="nextPage()"
            [disabled]="isLastPage || isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Next →
        </button>
    </div>
</div>